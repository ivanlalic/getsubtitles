<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GetSubtitles</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        /* Add some styles for the loading spinner */
        #loading-spinner {
            display: none;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #processing-message {
            display: none;
            margin-left: 10px;
        }

        #transcript-container {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="GetSubtitlesLogo.png" alt="Logo" width="180" height="90">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="form-group">
                    <label for="url">Enter the URL of a video or audio file:</label>
                    <input type="url" id="url" name="url" class="form-control">
                </div>
            </div>
            <div class="col-lg-6">
                <div class="form-group">
                    <label for="file">Upload a video file:</label>
                    <input type="file" id="file" name="file" accept="video/*" class="form-control">
                </div>
            </div>
        </div>
        <button id="get-subtitles" class="btn btn-primary mt-3">Get Subtitles</button>
        <div id="loading-spinner"></div>
        <p id="processing-message">Your file is being processed, please do not close the tab</p>
        <div id="webhook-response"></div>
        <div id="warning-message" class="alert alert-warning mt-3" style="display: none;">
            We need a URL or a file to start the process.
        </div>
        <div id="transcript-container">
            <button id="toggle-transcript" class="btn btn-secondary">Show/Hide Transcript</button>
            <p id="full-transcript" style="display: none;"></p>
        </div>
        <button id="download-srt" class="btn btn-success" style="display: none;">Download SRT</button>
        <button id="download-vtt" class="btn btn-success" style="display: none;">Download VTT</button>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const urlInput = document.getElementById('url');
        const fileInput = document.getElementById('file');
        const getSubtitlesButton = document.getElementById('get-subtitles');
        const webhookResponse = document.getElementById('webhook-response');
        const transcriptContainer = document.getElementById('transcript-container');
        const fullTranscript = document.getElementById('full-transcript');
        const toggleTranscriptButton = document.getElementById('toggle-transcript');
        const downloadSRTButton = document.getElementById('download-srt');
        const downloadVTTButton = document.getElementById('download-vtt');
        const loadingSpinner = document.getElementById('loading-spinner');
        const processingMessage = document.getElementById('processing-message');

        let isProcessing = false; // Flag to track processing status

        const startProcessing = () => {
    getSubtitlesButton.style.display = 'none';
    loadingSpinner.style.display = 'inline-block';
    processingMessage.style.display = 'inline';
    isProcessing = true;
};

const stopProcessing = () => {
    // Hide the "Get Subtitles" button
    getSubtitlesButton.style.display = 'none';

    // Check if the latest response contains payload.transcription before hiding the spinner
    if (latestResponse && latestResponse.payload && latestResponse.payload.transcription) {
        loadingSpinner.style.display = 'none';
    }

    // Hide the processing message
    processingMessage.style.display = 'none';

    isProcessing = false;
};

const handleGetSubtitlesClick = async () => {
    if (isProcessing) {
        return;
    }

    // Hide any existing warning messages
    const warningMessage = document.getElementById('warning-message');
    warningMessage.style.display = 'none';

    const audio_url = urlInput.value;
    const file = fileInput.files[0];

    if (!audio_url && !file) {
        // Display the warning message and return early
        warningMessage.style.display = 'block';
        return;
    }

    try {
        startProcessing();

        const formData = new FormData();
        if (file) {
            formData.append('audio', file);
        } else {
            formData.append('audio_url', audio_url);
        }

        const response = await fetch('https://getsubtitlesserverv2.onrender.com/get-subtitles', {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Gladia API Response:', data);
    } catch (error) {
        console.error(error);
        webhookResponse.textContent = 'Error fetching subtitles.';
    } finally {
        stopProcessing();
    }
};

        getSubtitlesButton.addEventListener('click', handleGetSubtitlesClick);

        // Existing code for WebSocket initialization
        const socket = new WebSocket('wss://getsubtitlesserverv2.onrender.com');
        let responseCount = 0; // Track the number of responses received

        socket.addEventListener('open', (event) => {
            console.log('WebSocket connection opened:', event);
        });

        socket.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data);

            // If it's the first response (without payload), increment the response count
            if (!data.payload) {
                responseCount++;
            }

            // If it's the final response (with payload), process it
            if (data.payload) {
                // Display the full transcript
                fullTranscript.textContent = data.payload.transcription.full_transcript;

                // Show download buttons
                downloadSRTButton.style.display = 'block';
                downloadVTTButton.style.display = 'block';

                // Update download links with appropriate data
                const audioName = urlInput.value.split('/').pop() || fileInput.files[0]?.name || 'audio'; // Extract audio name from URL or file
                const srtContent = data.payload.transcription.subtitles.find(sub => sub.format === 'srt').subtitles;
                const vttContent = data.payload.transcription.subtitles.find(sub => sub.format === 'vtt').subtitles;

                downloadSRTButton.addEventListener('click', () => {
                    const srtLink = document.createElement('a');
                    const srtBlob = new Blob([srtContent], { type: 'text/srt' });
                    srtLink.href = URL.createObjectURL(srtBlob);
                    srtLink.download = audioName + '.srt';
                    srtLink.click();
                });

                downloadVTTButton.addEventListener('click', () => {
                    const vttLink = document.createElement('a');
                    const vttBlob = new Blob([vttContent], { type: 'text/vtt' });
                    vttLink.href = URL.createObjectURL(vttBlob);
                    vttLink.download = audioName + '.vtt';
                    vttLink.click();
                });

                // Show transcript container
                transcriptContainer.style.display = 'block';

                // Toggle transcript visibility
                toggleTranscriptButton.addEventListener('click', () => {
                    const displayStyle = fullTranscript.style.display;
                    fullTranscript.style.display = displayStyle === 'none' ? 'block' : 'none';
                });

                // Hide loading spinner and processing message only when the last response is received
                responseCount++;
                if (responseCount === 2) {
                    loadingSpinner.style.display = 'none';
                    processingMessage.style.display = 'none';
                }
            }
        });

        socket.addEventListener('close', (event) => {
            console.log('WebSocket connection closed:', event);
        });
    });
</script>
</body>
</html>